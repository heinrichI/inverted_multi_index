<!DOCTYPE html>
<!-- saved from url=(0068)http://mccormickml.com/2017/10/22/product-quantizer-tutorial-part-2/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick
    
  </title>

  <link rel="stylesheet" href="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://mccormickml.com/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://mccormickml.com/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Chris McCormick" href="http://mccormickml.com/atom.xml">

  <!-- Adding support for MathJax -->
  <script async="" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/analytics.js.Без названия"></script><script src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/MathJax.js.Без названия" id=""></script>

<script src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/embed.js.Без названия" data-timestamp="1612279648371"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.0f8247d0689845c86c5bfcd8efd31a28.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.38ea27189bdb723eae3dabf5bc7b8c0b.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.ec325e7c33ae32f082a2c57fe0c859bd.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><script src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js.Без названия" async="" charset="UTF-8"></script></head>


  <body><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="http://mccormickml.com/" title="Home">Chris McCormick</a>

          <!--- Display the About, Archive, etc. pages in the header --->
          
              &nbsp;&nbsp;&nbsp;<small><a href="http://mccormickml.com/about/">About</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="http://mccormickml.com/tutorials/">Tutorials</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="https://www.chrismccormick.ai/store">Store</a></small>
          
              &nbsp;&nbsp;&nbsp;<small><a href="http://mccormickml.com/archive/">Archive</a></small>
          

        </h3>
        <!---- I could use this to include the tag line, but it looks cluttered...
        <h3 class="masthead-title">
             <small>Machine Learning Tutorials and Insights</small>
        </h3>
        ----->
        
        <small>New BERT eBook + 11 Application Notebooks! → <a href="https://bit.ly/2RkiwnL">The BERT Collection</a></small>
        

      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Product Quantizers for k-NN Tutorial Part 2</h1>
  <time datetime="2017-10-22T08:00:00-07:00" class="post-date">22 Oct 2017</time>
  <p>In <a href="http://mccormickml.com/2017/10/13/product-quantizer-tutorial-part-1/">part 1 of this tutorial</a>, I described the most basic form of a product quantizer. In this post, I’ll be explaining the <a href="https://github.com/facebookresearch/faiss/wiki/Getting-started-tutorial">IndexIVFPQ index from the FAISS library</a>, which uses a product quantizer as well as a couple additional techniques introduced in <a href="https://lear.inrialpes.fr/pubs/2011/JDS11/jegou_searching_with_quantization.pdf">their 2011 paper</a>.</p>

<p>Here is a brief summary of the two added features, followed by more detailed explanations.</p>

<p><em>Inverted File Index (IVF)</em>
The IVF is simply a technique for pre-filtering the dataset so that you don’t have to do an exhaustive search of <em>all</em> of the vectors. It’s pretty straightforward–you cluster the dataset ahead of time with k-means clustering to produce a large number (e.g., 100) of dataset partitions. Then, at query time, you compare your query vector to the partition centroids to find, e.g., the 10 closest clusters, and then you search against only the vectors in those partitions.</p>

<p><em>Encoding Residuals</em>
This is an enhancement to the basic product quantizer which incorporates information from the IVF step. For each database vector, instead of using the PQ to encode the original database vector we instead encode the vector’s <em>offset</em> from its partition centroid. I’ll explain why this works, and how it helps, in that section.</p>

<h2 id="inverted-file-index">Inverted File Index</h2>
<p>In Computer Science, and in Information Retrieval in particular, an “inverted index” refers to a text search index which maps every word in the vocabulary to all of its locations in all of the documents in the database. It’s a lot like the index you’d find in the back of a textbook, mapping words or concepts to page numbers, so it’s always bugged me that they call this data structure an <em>inverted</em> index (cause it seems like a <em>normal</em> index to me!).</p>

<p>Anyhow, in this context, the technique really just means partitioning the dataset using k-means clustering so that you can refine your search to only some of the partitions and ignore the rest.</p>

<p>As part of building the index, you use k-means clustering to cluster the dataset into a large number of partitions. Each vector in the dataset now belongs to one (and only one) of these clusters / partitions. And for each partition, you have a list of all the vectors that it contains (these are the “inverted file lists” referred to by the authors). You also have a matrix of all of the partition centroids, which will be used to figure out which partitions to search.</p>

<p>Dividing the dataset up this way isn’t perfect, because if a query vector falls on the outskirts of the closest cluster, then it’s nearest neighbors are likely sitting in multiple nearby clusters. The solution to this issue is simply to search multiple partitions. Searching multiple nearby partitions obviously takes more time, but gives us better accuracy.</p>

<p>At search time, you compare your query vector to all of the partition centroids to find the closest ones. Exactly how many is configurable. Once you’ve found the closest centroids, you select only the dataset vectors from those partitions, and do your k-NN search using the product quantizer.</p>

<p>A few notes on terminology:</p>
<ul>
  <li>The verb “probe” is used in this context to refer to selecting partitions to search. So in the code you’ll see the index parameter “nprobe” meaning “number of partitions to probe”.</li>
  <li>The authors of FAISS like to use the term Voronoi cells (instead of “dataset partitions”, as I’ve been using). A Voronoi cell is just the region of space that belongs to a cluster. That is, it covers all the points in space where a vector would be closer to that cluster’s centroid than any other.</li>
</ul>

<h2 id="encoding-residuals">Encoding Residuals</h2>
<p>This step is also relatively straightforward, but seems strange until you understand it. The idea is to incorporate some of the information from the IVF step into the product quantizer to improve its accuracy (so this concept definitely builds <em>on top of</em> the dataset partitioning technique).</p>

<p>First let’s define what a ‘residual’ vector is. And let’s tear out the product quantizer for now since it complicates things–we’ll add it back in later. That is, pretend we’re doing standard brute-force k-NN, but using the dataset partitioning technique to cut down on the number of vectors we search.</p>

<p>Let’s say you’ve clustered your dataset with k-means and now you have 100 clusters (or “dataset partitions”). For a given dataset vector, its residual is its offset from its partition centroid. That is, take the dataset vector and subtract from it the centroid vector of the cluster it belongs to. The centroid is just the mean of the cluster, so what happens when you subtract the mean from a collection points? They’re now all centered around 0. Here’s a simple two dimensional example.</p>

<p><a href="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/residuals_one_partition.png"><img src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/residuals_one_partition.png" alt="Illustration of residuals recentered around 0"></a></p>

<p>So here’s something interesting. Let’s say you replace all of the vectors in a partition with their residuals as in the above illustration. If you now have a query vector, and you want to find its nearest neighbors within this partition, you can calculate the query vector’s residual (it’s offset from the partition centroid), and then do your nearest neighbor search against the dataset vector residuals. And you’ll get the same result as using the original vectors!</p>

<p>I think you can see this intuitively in the illustration, but let’s also look at the equation. The L2 distance between two vectors ‘x’ and ‘y’, each of length ‘n’, is given by:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msqrt&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;msup&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/msqrt&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 15.045em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.976em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(0.519em, 1012.98em, 3.795em, -999.998em); top: -2.325em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-4" style="font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-5" style="font-family: MathJax_Math-italic;">s</span><span class="msubsup" id="MathJax-Span-6"><span style="display: inline-block; position: relative; width: 1.252em; height: 0px;"><span style="position: absolute; clip: rect(3.235em, 1000.35em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-7" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.347em;"><span class="texatom" id="MathJax-Span-8"><span class="mrow" id="MathJax-Span-9"><span class="mi" id="MathJax-Span-10" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span class="mn" id="MathJax-Span-11" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-12" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-13"><span class="mrow" id="MathJax-Span-14"><span class="mi" id="MathJax-Span-15" style="font-family: MathJax_Math-italic;">x</span></span></span><span class="mo" id="MathJax-Span-16" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-17" style="padding-left: 0.175em;"><span class="mrow" id="MathJax-Span-18"><span class="mi" id="MathJax-Span-19" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span></span></span><span class="mo" id="MathJax-Span-20" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-21" style="font-family: MathJax_Main; padding-left: 0.261em;">=</span><span class="msqrt" id="MathJax-Span-22" style="padding-left: 0.261em;"><span style="display: inline-block; position: relative; width: 6.769em; height: 0px;"><span style="position: absolute; clip: rect(2.33em, 1005.74em, 5.347em, -999.998em); top: -4.006em; left: 0.994em;"><span class="mrow" id="MathJax-Span-23"><span class="munderover" id="MathJax-Span-24"><span style="display: inline-block; position: relative; width: 1.468em; height: 0px;"><span style="position: absolute; clip: rect(2.933em, 1001.38em, 4.571em, -999.998em); top: -4.006em; left: 0em;"><span class="mo" id="MathJax-Span-25" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.407em, 1000.22em, 4.269em, -999.998em); top: -2.929em; left: 0.606em;"><span class="texatom" id="MathJax-Span-26"><span class="mrow" id="MathJax-Span-27"><span class="mi" id="MathJax-Span-28" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.45em, 1000.43em, 4.14em, -999.998em); top: -5.17em; left: 0.519em;"><span class="texatom" id="MathJax-Span-29"><span class="mrow" id="MathJax-Span-30"><span class="mi" id="MathJax-Span-31" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-32" style="padding-left: 0.175em;"><span style="display: inline-block; position: relative; width: 4.14em; height: 0px;"><span style="position: absolute; clip: rect(3.149em, 1003.58em, 4.399em, -999.998em); top: -4.006em; left: 0em;"><span class="mrow" id="MathJax-Span-33"><span class="mo" id="MathJax-Span-34" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-35"><span class="msubsup" id="MathJax-Span-36"><span style="display: inline-block; position: relative; width: 0.907em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-37" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.563em;"><span class="texatom" id="MathJax-Span-38"><span class="mrow" id="MathJax-Span-39"><span class="mi" id="MathJax-Span-40" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-41" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="msubsup" id="MathJax-Span-42" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 0.821em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.356em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-43" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.476em;"><span class="texatom" id="MathJax-Span-44"><span class="mrow" id="MathJax-Span-45"><span class="mi" id="MathJax-Span-46" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-47" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -4.481em; left: 3.709em;"><span class="texatom" id="MathJax-Span-48"><span class="mrow" id="MathJax-Span-49"><span class="mn" id="MathJax-Span-50" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.623em, 1005.78em, 3.925em, -999.998em); top: -5.343em; left: 0.994em;"><span style="display: inline-block; position: relative; width: 5.778em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: -0.084em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: 5.088em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 0.39em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 0.95em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.468em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.985em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 2.502em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.019em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.537em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.054em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.571em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(2.114em, 1001.04em, 5.39em, -999.998em); top: -3.92em; left: 0em;"><span style="font-family: MathJax_Size4;">√</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.33em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.597em; border-left: 0px solid; width: 0px; height: 3.603em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>d</mi><mi>i</mi><mi>s</mi><msub><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mn>2</mn></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi>x</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi>y</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><msqrt><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><msup><mrow><mo>(</mo><mrow><msub><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>y</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></mrow><mo>)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mn>2</mn></mrow></msup></msqrt></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-1">dist_{L2} ( {x}, {y} ) = \sqrt{\sum_{i}^{n}\left ( x_{i} - y_{i} \right )^{2}}</script>

<p>What happens if we subtract a centroid vector ‘c’ from both ‘x’ and ‘y’?</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;t&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msqrt&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;msup&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/msqrt&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msqrt&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/munderover&gt;&lt;msup&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/msqrt&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-51" style="width: 34.571em; display: inline-block;"><span style="display: inline-block; position: relative; width: 29.787em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(0.519em, 1029.79em, 3.795em, -999.998em); top: -2.325em; left: 0em;"><span class="mrow" id="MathJax-Span-52"><span class="mi" id="MathJax-Span-53" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mi" id="MathJax-Span-54" style="font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-55" style="font-family: MathJax_Math-italic;">s</span><span class="msubsup" id="MathJax-Span-56"><span style="display: inline-block; position: relative; width: 1.252em; height: 0px;"><span style="position: absolute; clip: rect(3.235em, 1000.35em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-57" style="font-family: MathJax_Math-italic;">t</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.347em;"><span class="texatom" id="MathJax-Span-58"><span class="mrow" id="MathJax-Span-59"><span class="mi" id="MathJax-Span-60" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span class="mn" id="MathJax-Span-61" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-62" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-63" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-64" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="mi" id="MathJax-Span-65" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">c</span><span class="mo" id="MathJax-Span-66" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math-italic; padding-left: 0.175em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span class="mo" id="MathJax-Span-68" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="mi" id="MathJax-Span-69" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">c</span><span class="mo" id="MathJax-Span-70" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-71" style="font-family: MathJax_Main; padding-left: 0.261em;">=</span><span class="msqrt" id="MathJax-Span-72" style="padding-left: 0.261em;"><span style="display: inline-block; position: relative; width: 12.244em; height: 0px;"><span style="position: absolute; clip: rect(2.33em, 1011.21em, 5.347em, -999.998em); top: -4.006em; left: 0.994em;"><span class="mrow" id="MathJax-Span-73"><span class="munderover" id="MathJax-Span-74"><span style="display: inline-block; position: relative; width: 1.468em; height: 0px;"><span style="position: absolute; clip: rect(2.933em, 1001.38em, 4.571em, -999.998em); top: -4.006em; left: 0em;"><span class="mo" id="MathJax-Span-75" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.407em, 1000.22em, 4.269em, -999.998em); top: -2.929em; left: 0.606em;"><span class="texatom" id="MathJax-Span-76"><span class="mrow" id="MathJax-Span-77"><span class="mi" id="MathJax-Span-78" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.45em, 1000.43em, 4.14em, -999.998em); top: -5.17em; left: 0.519em;"><span class="texatom" id="MathJax-Span-79"><span class="mrow" id="MathJax-Span-80"><span class="mi" id="MathJax-Span-81" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-82" style="padding-left: 0.175em;"><span style="display: inline-block; position: relative; width: 9.614em; height: 0px;"><span style="position: absolute; clip: rect(3.149em, 1009.1em, 4.399em, -999.998em); top: -4.006em; left: 0em;"><span class="mrow" id="MathJax-Span-83"><span class="mo" id="MathJax-Span-84" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-85"><span class="mrow" id="MathJax-Span-86"><span class="mo" id="MathJax-Span-87" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-88"><span class="msubsup" id="MathJax-Span-89"><span style="display: inline-block; position: relative; width: 0.907em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-90" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.563em;"><span class="texatom" id="MathJax-Span-91"><span class="mrow" id="MathJax-Span-92"><span class="mi" id="MathJax-Span-93" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-94" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="msubsup" id="MathJax-Span-95" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 0.735em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.43em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-96" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.433em;"><span class="texatom" id="MathJax-Span-97"><span class="mrow" id="MathJax-Span-98"><span class="mi" id="MathJax-Span-99" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-100" style="font-family: MathJax_Main;">)</span></span><span class="mo" id="MathJax-Span-101" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="mrow" id="MathJax-Span-102" style="padding-left: 0.218em;"><span class="mo" id="MathJax-Span-103" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-104"><span class="msubsup" id="MathJax-Span-105"><span style="display: inline-block; position: relative; width: 0.821em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.356em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-106" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.476em;"><span class="texatom" id="MathJax-Span-107"><span class="mrow" id="MathJax-Span-108"><span class="mi" id="MathJax-Span-109" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-110" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="msubsup" id="MathJax-Span-111" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 0.735em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.43em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-112" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.433em;"><span class="texatom" id="MathJax-Span-113"><span class="mrow" id="MathJax-Span-114"><span class="mi" id="MathJax-Span-115" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-116" style="font-family: MathJax_Main;">)</span></span></span><span class="mo" id="MathJax-Span-117" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -4.481em; left: 9.183em;"><span class="texatom" id="MathJax-Span-118"><span class="mrow" id="MathJax-Span-119"><span class="mn" id="MathJax-Span-120" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.623em, 1011.25em, 3.925em, -999.998em); top: -5.343em; left: 0.994em;"><span style="display: inline-block; position: relative; width: 11.252em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: -0.084em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: 10.563em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 0.433em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.037em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.597em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 2.157em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 2.718em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.278em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.838em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.399em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.959em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 5.519em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 6.08em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 6.64em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 7.2em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 7.761em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 8.321em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 8.881em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 9.442em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 10.002em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(2.114em, 1001.04em, 5.39em, -999.998em); top: -3.92em; left: 0em;"><span style="font-family: MathJax_Size4;">√</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-121" style="font-family: MathJax_Main; padding-left: 0.261em;">=</span><span class="msqrt" id="MathJax-Span-122" style="padding-left: 0.261em;"><span style="display: inline-block; position: relative; width: 6.769em; height: 0px;"><span style="position: absolute; clip: rect(2.33em, 1005.74em, 5.347em, -999.998em); top: -4.006em; left: 0.994em;"><span class="mrow" id="MathJax-Span-123"><span class="munderover" id="MathJax-Span-124"><span style="display: inline-block; position: relative; width: 1.468em; height: 0px;"><span style="position: absolute; clip: rect(2.933em, 1001.38em, 4.571em, -999.998em); top: -4.006em; left: 0em;"><span class="mo" id="MathJax-Span-125" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.407em, 1000.22em, 4.269em, -999.998em); top: -2.929em; left: 0.606em;"><span class="texatom" id="MathJax-Span-126"><span class="mrow" id="MathJax-Span-127"><span class="mi" id="MathJax-Span-128" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.45em, 1000.43em, 4.14em, -999.998em); top: -5.17em; left: 0.519em;"><span class="texatom" id="MathJax-Span-129"><span class="mrow" id="MathJax-Span-130"><span class="mi" id="MathJax-Span-131" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-132" style="padding-left: 0.175em;"><span style="display: inline-block; position: relative; width: 4.14em; height: 0px;"><span style="position: absolute; clip: rect(3.149em, 1003.58em, 4.399em, -999.998em); top: -4.006em; left: 0em;"><span class="mrow" id="MathJax-Span-133"><span class="mo" id="MathJax-Span-134" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-135"><span class="msubsup" id="MathJax-Span-136"><span style="display: inline-block; position: relative; width: 0.907em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.14em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-137" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.563em;"><span class="texatom" id="MathJax-Span-138"><span class="mrow" id="MathJax-Span-139"><span class="mi" id="MathJax-Span-140" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span><span class="mo" id="MathJax-Span-141" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="msubsup" id="MathJax-Span-142" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 0.821em; height: 0px;"><span style="position: absolute; clip: rect(3.45em, 1000.52em, 4.356em, -999.998em); top: -4.006em; left: 0em;"><span class="mi" id="MathJax-Span-143" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -3.877em; left: 0.476em;"><span class="texatom" id="MathJax-Span-144"><span class="mrow" id="MathJax-Span-145"><span class="mi" id="MathJax-Span-146" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-147" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; top: -4.481em; left: 3.709em;"><span class="texatom" id="MathJax-Span-148"><span class="mrow" id="MathJax-Span-149"><span class="mn" id="MathJax-Span-150" style="font-size: 70.7%; font-family: MathJax_Main;">2</span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(3.623em, 1005.78em, 3.925em, -999.998em); top: -5.343em; left: 0.994em;"><span style="display: inline-block; position: relative; width: 5.778em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: -0.084em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -4.006em; left: 5.088em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 0.39em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 0.95em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.468em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 1.985em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 2.502em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.019em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 3.537em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.054em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -4.006em; left: 4.571em;">−<span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span><span style="position: absolute; clip: rect(2.114em, 1001.04em, 5.39em, -999.998em); top: -3.92em; left: 0em;"><span style="font-family: MathJax_Size4;">√</span><span style="display: inline-block; width: 0px; height: 4.011em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.33em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.597em; border-left: 0px solid; width: 0px; height: 3.603em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>d</mi><mi>i</mi><mi>s</mi><msub><mi>t</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mn>2</mn></mrow></msub><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>c</mi><mo>,</mo><mi>y</mi><mo>−</mo><mi>c</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><msup><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><msub><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></mrow><mo>)</mo></mrow><mo>−</mo><mrow><mo>(</mo><mrow><msub><mi>y</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></mrow><mo>)</mo></mrow></mrow><mo>)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mn>2</mn></mrow></msup></msqrt><mo>=</mo><msqrt><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>n</mi></mrow></munderover><msup><mrow><mo>(</mo><mrow><msub><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>y</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></mrow><mo>)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mn>2</mn></mrow></msup></msqrt></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-2">dist_{L2} (x - c, y - c) = \sqrt{\sum_{i}^{n}\left ( \left ( x_{i} - c_{i}  \right ) - \left ( y_{i} - c_{i} \right )\right )^{2}} = \sqrt{\sum_{i}^{n}\left ( x_{i} - y_{i} \right )^{2}}</script>

<p>The centroid components just cancel out!</p>

<p>So note that this means that the distances calculated using the residuals are not only equivalent in relative terms (like the order of the distances), but we’re actually still calculating the <em>correct L2 distance</em> between the vectors!</p>

<p>You’ve probably already relied on this equivalence before, since mean normalization (subtracting the mean from your vectors) is a common pre-processing technique.</p>

<p>So that’s within a single partition, but what about comparing against vectors in different partitions? We’re still good, so long as we re-calculate the query vector residual for each partition.</p>

<p>Take a look at the following illustration with two partitions. After calculating the residuals, all of the points from both partitions are now centered around 0. But now we have two query vector residuals–one for comparing against the blue points (partition 1) and another for the green points (partition 2).</p>

<p><a href="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/residuals_two_partitions.png"><img src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/residuals_two_partitions.png" alt="Illustration of residuals for two partitions"></a></p>

<p>Note how the distances between the query and the points are still the same before and after!</p>

<p>So this is all very interesting, but so far useless. We haven’t changed our accuracy or reduced the compute burden at all. To see where we benefit from this, we have to bring the PQ back in to the picture.</p>

<p>Before training our product quantizer, we’re first going to calculate the residuals for all of the dataset vectors across all of the partitions. We’re still going to keep the residuals separated by partition (we’re not combining them), but now all of these residuals are all centered around 0, and relatively tightly grouped. And we’re actually going to <em>toss the original dataset vectors</em>, and just store the residuals from here on out.</p>

<p>Now we learn a product quantizer on all of these residual vectors instead of the original vectors. So what’s changed? Remember that the product quantizer works by dividing up the vectors into subvectors, and running k-means clustering on them to learn a set of prototypes (or a “code book”) to use to represent all of the vectors. What we’ve done by replacing the vectors with their residuals is that we’ve reduced the variety in the dataset (In the paper, this is described by saying that the residual vectors “have less energy” than the originals.). Where before the clusters were all in different regions of space, now all of the clusters are centered around 0 and overlapping one another. By reducing the variety in the dataset, it takes fewer prototypes (or “codes”) to represent the vectors effectively! Or, from another perspective, our limited number of codes in the PQ are now going to be more accurate because the vectors they have to describe are less distinct than they were. We’re getting more bang for our buck!</p>

<p>There is a cost to this, though. Remember that the magic of Product Quantizers is that you only have to calculate a relatively small table of partial distances between the query vector chunks and the codes in the codebooks–the rest is look-ups and summations.</p>

<p>But now with the residuals, the query vector is <em>different for each partition</em>–in each partition, the residual for the query has to be re-calculated against that partition’s centroid. So we have to calculate a separate distance table for each partition we probe!</p>

<p>Apparently the trade-off is worth it, though, because the IndexIVFPQ works pretty well in practice.</p>

<p>And that’s really it. The database vectors have all been replaced by their residuals, but from the perspective of the Product Quantizer nothing’s different.</p>

<p>Note that the partitions don’t factor in to the codebook training. We still learn a codebook for each subvector using dataset vectors across all partitions. You <em>could</em> train separate PQs for each partition, but the authors decided against this because the number of partitions tends to be high, so the memory cost of storing all those codebooks is a problem. Instead, a single PQ is still learned from all of the database vectors from all partitions.</p>



  <script async="" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/f.txt"></script>
<!-- Responsive Unit - End of Post, Colorful -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9176681289361741" data-ad-slot="8514028518" data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  
  
  <div id="disqus_thread"><iframe id="dsq-app7430" name="dsq-app7430" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 1234px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe><iframe id="indicator-north" name="indicator-north" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 700px !important; border: none !important; overflow: hidden !important; top: 0px !important; min-width: 700px !important; max-width: 700px !important; position: fixed !important; z-index: 2147483646 !important; height: 0px !important; min-height: 0px !important; max-height: 0px !important; display: none !important;" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/saved_resource(1).html"></iframe><iframe id="indicator-south" name="indicator-south" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 700px !important; border: none !important; overflow: hidden !important; bottom: 0px !important; min-width: 700px !important; max-width: 700px !important; position: fixed !important; z-index: 2147483646 !important; height: 0px !important; min-height: 0px !important; max-height: 0px !important; display: none !important;" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/saved_resource(2).html"></iframe></div>
  <script>
  
      var disqus_config = function () {
          this.page.url = "http://mccormickml.com/2017/10/22/product-quantizer-tutorial-part-2/"
          this.page.identifier = "/2017/10/22/product-quantizer-tutorial-part-2/"
      };
      
      var disqus_shortname = 'mccormickml';
      // var disqus_developer = 1; // Comment out when the site is live
      var disqus_title      = 'Product Quantizers for k-NN Tutorial Part 2';
      
      (function() {  // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';        
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
  
</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="http://mccormickml.com/2020/10/05/multilingual-bert/">
          How to Apply BERT to Arabic and Other Languages
          <small><time datetime="2020-10-05T09:00:00-07:00">05 Oct 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="http://mccormickml.com/2020/07/29/smart-batching-tutorial/">
          Smart Batching Tutorial - Speed Up BERT Training
          <small><time datetime="2020-07-29T09:00:00-07:00">29 Jul 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="http://mccormickml.com/2020/07/21/gpu-benchmarks-for-fine-tuning-bert/">
          GPU Benchmarks for Fine-Tuning BERT
          <small><time datetime="2020-07-21T09:00:00-07:00">21 Jul 2020</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>
      
      <footer class="footer">
        <small>
          © <time datetime="2020-10-13T05:39:02-07:00">2020</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
     <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-76624103-1', 'auto');
       ga('send', 'pageview');
     </script>
    
  

<iframe style="display: none;" src="./Product Quantizers for k-NN Tutorial Part 2 · Chris McCormick_files/saved_resource(3).html"></iframe><div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size4, sans-serif;"></div></div></body></html>